<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Admin | [SUA GRÁFICA] B2B</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700&family=Inter:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        /* --- TEMA CORPORATE DARK (Baseado no seu Portfólio) --- */
        :root {
            /* CORRIGIDO: Cores de fundo alteradas para tons de Vinho escuro */
            --background: #1A0505; /* Preto muito escuro com toque de vinho */
            --surface: #2B0C0C; /* Superfície/Card, um pouco mais claro */
            --border: #440F0F; /* Borda um pouco mais clara que a surface */
            --text-primary: #F8FAFC; /* Slate 50 */
            --text-secondary: #D9CFCF; /* Tom off-white para contraste */
            --accent: #8B0000; /* Vinho / Dark Red */
            --accent-hover: #5D0000; /* Vinho mais escuro para hover */
            
            --font-body: 'Inter', sans-serif;
            --font-heading: 'Montserrat', sans-serif;
            
            --status-pending: #FACC15; /* Amarelo */
            --status-confirmed: #10B981; /* Verde */
            --status-rejected: #EF4444; /* Vermelho */
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: var(--font-body); background-color: var(--background);
            color: var(--text-secondary); line-height: 1.6;
            min-height: 100vh; display: flex; flex-direction: column;
        }
        .container { max-width: 1200px; margin: 0 auto; padding: 0 2rem; }
        h1, h2, h3 { font-family: var(--font-heading); color: var(--text-primary); }
        .btn { padding: 0.8rem 1.5rem; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; transition: all 0.3s; }
        .btn-primary { background-color: var(--accent); color: var(--text-primary); }
        .btn-primary:hover { background-color: var(--accent-hover); }
        .btn-danger { background-color: var(--status-rejected); color: var(--text-primary); }
        .btn-danger:hover { background-color: #c13030; }
        .btn-success { background-color: var(--status-confirmed); color: var(--text-primary); }
        .btn-success:hover { background-color: #0d996a; }
        .btn-action { padding: 0.5rem 1rem; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; }
        .error-msg { color: var(--status-rejected); margin-top: 1rem; display: none; }
        .success-msg { color: var(--status-confirmed); margin-top: 1rem; display: none; }
        
        /* --- TELA DE LOGIN (Adaptada do laisvitor_admin) --- */
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--background); z-index: 2000; display: flex; align-items: center; justify-content: center; }
        .login-box { background-color: var(--surface); padding: 3rem; border-radius: 12px; border: 1px solid var(--border); width: 100%; max-width: 400px; text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.5); }
        .login-box h2 { font-size: 2rem; margin-bottom: 2rem; color: var(--text-primary); }
        .input-group { margin-bottom: 1.5rem; text-align: left; }
        .input-group label { display: block; margin-bottom: 0.5rem; color: var(--text-primary); }
        .input-group input, .input-group textarea, .input-group select { width: 100%; padding: 0.8rem; border-radius: 8px; border: 1px solid var(--border); background-color: var(--background); color: var(--text-primary); font-family: var(--font-body); }
        .input-group input:focus, .input-group textarea:focus, .input-group select:focus { border-color: var(--accent); outline: none; }
        /* CORRIGIDO: Removido background: #fff e padding: 5px */
        .logo-img { height: 60px; margin-bottom: 1.5rem; border-radius: 8px;} 

        /* --- PAINEL PRINCIPAL --- */
        #admin-panel { display: none; flex: 1; flex-direction: column; }
        header { padding: 1rem 0; background-color: var(--surface); border-bottom: 1px solid var(--border); }
        .admin-header { display: flex; justify-content: space-between; align-items: center; }
        .btn-logout { padding: 0.5rem 1rem; background: transparent; border: 1px solid var(--accent); color: var(--accent); border-radius: 6px; cursor: pointer; transition: all 0.3s; }
        .btn-logout:hover { background: var(--accent); color: var(--text-primary); }

        #admin-hero { background-color: var(--surface); padding: 50px 0 0; position: relative; color: white; text-align: center; }
        #admin-hero h1 { font-size: 2.5rem; margin-bottom: 0.5rem; color: var(--accent); }
        #admin-hero p { font-size: 1.2rem; color: var(--text-secondary); }

        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-top: 30px; margin-bottom: 30px; }
        /* Cards também usam a cor surface */
        .stat-card { background-color: var(--surface); padding: 2rem; border-radius: 12px; border: 1px solid var(--border); text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .stat-number { font-family: var(--font-heading); font-size: 3rem; font-weight: 700; color: var(--text-primary); line-height: 1; margin-bottom: 0.5rem; }
        .stat-label { font-size: 1rem; color: var(--text-secondary); font-weight: 500; }

        .admin-section { padding: 4rem 0; border-bottom: 1px solid var(--border); }
        .admin-section:nth-child(odd) { background-color: var(--surface); }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem;}
        .section-header h2 { font-size: 2rem; }
        
        .admin-table { width: 100%; border-collapse: collapse; background-color: var(--background); border-radius: 8px; overflow: hidden; border: 1px solid var(--border); }
        .admin-table th, .admin-table td { padding: 1rem; text-align: left; border-bottom: 1px solid var(--border); }
        .admin-table th { background-color: rgba(0,0,0,0.2); color: var(--text-primary); font-weight: 600; }
        .status-badge { padding: 0.3rem 0.8rem; border-radius: 20px; font-size: 0.8rem; font-weight: 700; color: #fff; display: inline-block; }
        .status-Ativo, .status-true { background-color: var(--status-confirmed); }
        .status-Inativo, .status-false { background-color: var(--status-rejected); }
        
        .product-image-cell img { height: 40px; width: 40px; object-fit: cover; border-radius: 4px; background: #fff; }

        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.8); z-index: 5000; display: none; align-items: center; justify-content: center; }
        .modal-content { background-color: var(--surface); padding: 2rem; border-radius: 12px; width: 90%; max-width: 600px; position: relative; border-top: 5px solid var(--accent); box-shadow: 0 15px 40px rgba(0,0,0,0.7); max-height: 90vh; overflow-y: auto; }
        .modal-close { position: absolute; top: 10px; right: 10px; background: none; border: none; color: var(--text-secondary); font-size: 1.5rem; cursor: pointer; }
        .modal-content h3 { color: var(--accent); margin-bottom: 1rem; }
        .modal-buttons { display: flex; justify-content: flex-end; gap: 1rem; margin-top: 1.5rem; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        .form-grid .full-width { grid-column: 1 / -1; }
        .form-check { display: flex; align-items: center; gap: 0.5rem; background: var(--background); padding: 0.8rem; border-radius: 8px; }
        .form-check input { width: auto; }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-box">
            <!-- Use seu logo.png aqui -->
            <img src="logo.png" alt="[SUA GRÁFICA] Logo" class="logo-img">
            <h2>Painel Admin B2B</h2>
            <form id="login-form">
                <div class="input-group">
                    <label for="username">Usuário (Admin)</label>
                    <!-- VALOR CORRIGIDO: Deve ser 'admin' para bater com o seed do app.py -->
                    <input type="text" id="username" required value="admin">
                </div>
                <div class="input-group">
                    <label for="password">Chave de Acesso (Senha)</label>
                    <!-- VALOR CORRIGIDO: Valor padrão '123' para facilitar, mas o usuário deve digitá-lo -->
                    <input type="password" id="password" required value="123">
                </div>
                <!-- O id 'login-button' foi removido e o type="submit" adicionado para funcionar com o listener 'submit' -->
                <button type="submit" class="btn btn-primary" style="width: 100%;">Entrar</button> 
                <p class="error-msg" id="login-error">Credenciais inválidas.</p>
            </form>
        </div>
    </div>

    <div id="admin-panel">
        <header>
            <div class="container admin-header">
                 <!-- Use seu logo.png aqui -->
                <a href="#"><img src="logo.png" alt="[SUA GRÁFICA] Logo" class="logo-img" style="height: 40px;"></a>
                <button class="btn-logout" id="logout-btn">Sair <i class="fas fa-sign-out-alt"></i></button>
            </div>
        </header>

        <main>
            <div id="admin-hero">
                <div class="container">
                    <h1>Portal de Gerenciamento B2B</h1>
                    <p>Controle de Produtos, Clientes e Pedidos</p>
                </div>
                
                <div class="container">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number" id="stat-produtos">-</div>
                            <div class="stat-label">Produtos Ativos</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="stat-clientes">-</div>
                            <div class="stat-label">Clientes Cadastrados</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="stat-pedidos">-</div>
                            <div class="stat-label">Pedidos Pendentes</div>
                        </div>
                    </div>
                </div>
            </div>

            <section class="admin-section">
                <div class="container">
                    <div class="section-header">
                        <h2>Gerenciar Produtos (Catálogo B2B)</h2>
                        <button class="btn btn-primary" id="open-add-product-modal">+ Adicionar Novo Produto</button>
                    </div>
                    <table class="admin-table" id="products-table">
                        <thead>
                            <tr><th></th><th>Código</th><th>Nome</th><th>Preço Mín.</th><th>Múltiplos</th><th>Status</th><th>Ações</th></tr>
                        </thead>
                        <tbody>
                            <tr id="products-loading"><td colspan="7" style="text-align: center;">Carregando lista de produtos...</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <section class="admin-section">
                 <div class="container">
                    <div class="section-header">
                        <h2>Gerenciar Clientes B2B</h2>
                        <button class="btn btn-primary" id="open-add-client-modal">+ Adicionar Novo Cliente</button>
                    </div>
                    <table class="admin-table" id="clients-table">
                        <thead>
                            <tr><th>Nome/Empresa</th><th>CNPJ</th><th>Código de Acesso (Senha)</th><th>Status</th><th>Ações</th></tr>
                        </thead>
                        <tbody>
                            <tr id="clients-loading"><td colspan="5" style="text-align: center;">Carregando lista de clientes...</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>
        </main>
    </div>

    <!-- ====================================================== -->
    <!-- MODAL DE PRODUTOS (CRIAR E EDITAR) -->
    <!-- ====================================================== -->
    <div id="product-modal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close" id="close-product-modal">&times;</button>
            <h3 id="product-modal-title">Adicionar Novo Produto</h3> 
            <form id="product-form">
                <input type="hidden" id="product-id"> 
                
                <div class="form-grid">
                    <div class="input-group">
                        <label for="product-codigo">Código do Produto (SKU)</label>
                        <input type="text" id="product-codigo" placeholder="Ex: ER1458-AZU" required>
                    </div>
                     <div class="input-group">
                        <label for="product-name">Nome do Produto</label>
                        <input type="text" id="product-name" placeholder="Ex: Caneta Metal Azul" required>
                    </div>
                     <div class="input-group">
                        <label for="product-preco">Preço Mínimo (R$)</label>
                        <input type="number" id="product-preco" step="0.01" placeholder="Ex: 2.10" required>
                    </div>
                     <div class="input-group">
                        <label for="product-multiplos">Múltiplos de (Qtd)</label>
                        <input type="number" id="product-multiplos" step="1" value="1" required>
                    </div>
                </div>
                
                <div class="input-group full-width">
                    <label for="product-url">URL da Imagem</label>
                    <input type="text" id="product-url" placeholder="https://.../imagem.png">
                </div>
                 <div class="input-group full-width">
                    <label for="product-description">Descrição (Regras, etc)</label>
                    <textarea id="product-description" rows="2" placeholder="Ex: Venda em Múltiplos de 50. Valor abaixo do mínimo +5%"></textarea>
                </div>
                
                <div class="form-grid">
                    <div class="form-check">
                        <input type="checkbox" id="product-estoque" checked>
                        <label for="product-estoque">Estoque Disponível?</label>
                    </div>
                    <div class="form-check">
                        <input type="checkbox" id="product-ativo" checked>
                        <label for="product-ativo">Produto Ativo (Aparece no portal)?</label>
                    </div>
                </div>

                <p class="error-msg" id="product-error-msg">Erro ao salvar.</p>
                <p class="success-msg" id="product-success-msg">Produto salvo com sucesso!</p>
                
                <div class="modal-buttons">
                    <button type="button" class="btn btn-danger" id="cancel-product">Cancelar</button>
                    <button type="submit" class="btn btn-success" id="save-product-btn">Salvar Produto</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- ====================================================== -->
    <!-- MODAL DE CLIENTES (CRIAR) -->
    <!-- ====================================================== -->
    <div id="client-modal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close" id="close-client-modal">&times;</button>
            <h3>Adicionar Novo Cliente</h3>
            <form id="client-form">
                <div class="input-group">
                    <label for="client-name">Nome do Cliente / Empresa</label>
                    <input type="text" id="client-name" required placeholder="Ex: Cliente Teste S.A.">
                </div>
                <div class="form-grid">
                    <div class="input-group">
                        <label for="client-cnpj">CNPJ (Opcional)</label>
                        <input type="text" id="client-cnpj" placeholder="00.000.000/0001-00">
                    </div>
                    <div class="input-group">
                        <label for="client-email">Email (Opcional)</label>
                        <input type="email" id="client-email" placeholder="contato@cliente.com">
                    </div>
                </div>
                <div class="input-group">
                    <label for="client-codigo">Código de Acesso (A "Senha" do cliente)</label>
                    <input type="text" id="client-codigo" required placeholder="Ex: CLIENTE123">
                </div>
                
                <p class="error-msg" id="client-error-msg">Erro ao salvar.</p>
                <p class="success-msg" id="client-success-msg">Cliente adicionado! Já pode acessar o portal.</p>
                
                <div class="modal-buttons">
                    <button type="button" class="btn btn-danger" id="cancel-client">Cancelar</button>
                    <button type="submit" class="btn btn-success" id="save-client-btn">Salvar Cliente</button>
                </div>
            </form>
        </div>
    </div>

    <!-- NOVO: Modal Simples para Alertas e Confirmações (Substitui alert/confirm) -->
    <div id="custom-dialog-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 400px; text-align: center;">
            <p id="dialog-message" style="margin-bottom: 1.5rem; color: var(--text-primary); font-size: 1.1rem;"></p>
            <div id="dialog-buttons" class="modal-buttons" style="justify-content: center;">
                <button type="button" class="btn btn-success" id="dialog-ok-btn">OK</button>
                <button type="button" class="btn btn-danger" id="dialog-cancel-btn" style="display:none;">Cancelar</button>
            </div>
        </div>
    </div>

    <script>
        // URL da API (do seu app.py)
        // NOTE: Se você estiver fazendo deploy, mude para a URL do Render/servidor, como 'https://suagrafica-portalcliente.onrender.com'
        const API_BASE_URL = 'https://suagrafica-portalcliente.onrender.com'; 

        // --- Seletores Globais ---
        const loginScreen = document.getElementById('login-screen');
        const adminPanel = document.getElementById('admin-panel');
        const loginForm = document.getElementById('login-form'); // Seleciona o formulário
        const logoutButton = document.getElementById('logout-btn');
        const loginErrorMsg = document.getElementById('login-error');

        // --- Seletores de Stats ---
        const statProdutosEl = document.getElementById('stat-produtos');
        const statClientesEl = document.getElementById('stat-clientes');
        const statPedidosEl = document.getElementById('stat-pedidos');

        // --- Seletores Modal Produto ---
        const productModal = document.getElementById('product-modal');
        const productModalTitle = document.getElementById('product-modal-title');
        const productForm = document.getElementById('product-form');
        const saveProductBtn = document.getElementById('save-product-btn');
        const productIdInput = document.getElementById('product-id');
        const productErrorMsg = document.getElementById('product-error-msg');
        const productSuccessMsg = document.getElementById('product-success-msg');
        const productsTableBody = document.querySelector('#products-table tbody');

        // --- Seletores Modal Cliente ---
        const clientModal = document.getElementById('client-modal');
        const clientForm = document.getElementById('client-form');
        const clientErrorMsg = document.getElementById('client-error-msg');
        const clientSuccessMsg = document.getElementById('client-success-msg');
        const clientsTableBody = document.querySelector('#clients-table tbody');

        // --- Seletores Dialog Customizado ---
        const customDialogModal = document.getElementById('custom-dialog-modal');
        const dialogMessage = document.getElementById('dialog-message');
        const dialogOkBtn = document.getElementById('dialog-ok-btn');
        const dialogCancelBtn = document.getElementById('dialog-cancel-btn');
        let confirmCallback = null;

        let isEditingProduct = false; // Flag para controlar se o modal de produto está editando ou criando

        // --- FUNÇÕES DE UTILS ---
        function getAuthHeaders() {
            const token = localStorage.getItem('admin_token');
            return {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            };
        }
        function formatCurrency(value) {
            return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
        }

        // --- FUNÇÕES DE DIÁLOGO CUSTOMIZADO (Substitui alert() e confirm()) ---
        function showCustomAlert(message) {
            dialogMessage.textContent = message;
            dialogOkBtn.style.display = 'block';
            dialogCancelBtn.style.display = 'none';
            customDialogModal.style.display = 'flex';
        }

        function showCustomConfirm(message, callback) {
            dialogMessage.textContent = message;
            dialogOkBtn.style.display = 'block';
            dialogCancelBtn.style.display = 'block';
            confirmCallback = callback;
            customDialogModal.style.display = 'flex';
        }

        dialogOkBtn.addEventListener('click', () => {
            customDialogModal.style.display = 'none';
            if (dialogCancelBtn.style.display !== 'none' && confirmCallback) {
                // Modo Confirm e OK pressionado
                confirmCallback(true);
                confirmCallback = null;
            } else if (confirmCallback) {
                // Modo Alert (ou Confirm e OK pressionado)
                confirmCallback = null;
            }
        });

        dialogCancelBtn.addEventListener('click', () => {
            customDialogModal.style.display = 'none';
            // Modo Confirm e Cancelar pressionado
            if (confirmCallback) {
                confirmCallback(false);
                confirmCallback = null;
            }
        });


        // --- FUNÇÕES DE AUTENTICAÇÃO ---
        function showPanel() {
            loginScreen.style.display = 'none';
            adminPanel.style.display = 'flex';
            loadDashboard(); // Carrega todos os dados
        }
        function showLogin() {
            loginScreen.style.display = 'flex';
            adminPanel.style.display = 'none';
            localStorage.removeItem('admin_token');
        }

        async function handleLogin() {
            const user = document.getElementById('username').value;
            const pass = document.getElementById('password').value; // Senha em texto puro
            
            loginErrorMsg.style.display = 'none';
            // Seleciona o botão pelo type=submit
            const loginButton = loginForm.querySelector('button[type="submit"]');
            loginButton.disabled = true;

            try {
                // CORREÇÃO API_BASE_URL
                const response = await fetch(`${API_BASE_URL}/api/admin/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: user, chave_admin: pass })
                });

                if (response.ok) {
                    const data = await response.json();
                    localStorage.setItem('admin_token', data.token); 
                    loginErrorMsg.style.display = 'none';
                    showPanel();
                } else {
                    const data = await response.json();
                    loginErrorMsg.textContent = data.erro || 'Usuário ou chave inválidos.';
                    loginErrorMsg.style.display = 'block';
                }
            } catch (error) {
                console.error('Erro no login:', error);
                loginErrorMsg.textContent = 'Erro ao conectar ao servidor.';
                loginErrorMsg.style.display = 'block';
            } finally {
                loginButton.disabled = false;
            }
        }
        
        // Evento 'submit' no formulário de login
        loginForm.addEventListener('submit', (e) => { 
            e.preventDefault(); 
            handleLogin(); 
        });
        
        logoutButton.addEventListener('click', showLogin);

        // --- CARREGAMENTO DO DASHBOARD (MÉTODO PRINCIPAL) ---
        async function loadDashboard() {
            if (!localStorage.getItem('admin_token')) return showLogin();
            loadDashboardStats();
            loadProductsTable();
            loadClientsTable(); 
        }
        
        async function loadDashboardStats() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/admin/dashboard_stats`, { headers: getAuthHeaders() });
                if (response.ok) {
                    const stats = await response.json();
                    statProdutosEl.textContent = stats.stat_produtos;
                    statClientesEl.textContent = stats.stat_clientes;
                    statPedidosEl.textContent = stats.stat_pedidos;
                } else if (response.status === 403) {
                    showLogin();
                }
            } catch (error) {
                console.error('Erro ao carregar stats:', error);
            }
        }
        
        // =============================================================
        // --- FUNÇÕES DE GERENCIAMENTO DE PRODUTOS ---
        // =============================================================
        
        async function loadProductsTable() {
            productsTableBody.innerHTML = '<tr id="products-loading"><td colspan="7" style="text-align: center;">Carregando...</td></tr>';
            try {
                const response = await fetch(`${API_BASE_URL}/api/admin/produtos`, { headers: getAuthHeaders() });
                if (!response.ok) {
                    if (response.status === 403) { showLogin(); return; }
                    throw new Error('Falha ao carregar produtos');
                }
                
                const products = await response.json();
                productsTableBody.innerHTML = '';
                
                if (products.length === 0) {
                     productsTableBody.innerHTML = '<tr><td colspan="7" style="text-align: center;">Nenhum produto cadastrado.</td></tr>';
                     return;
                }

                products.forEach(p => {
                    const statusClass = p.esta_ativo ? 'status-true' : 'status-false';
                    const statusText = p.esta_ativo ? 'Ativo' : 'Inativo';
                    
                    const row = productsTableBody.insertRow();
                    row.innerHTML = `
                        <td class="product-image-cell"><img src="${p.imagem_url || 'https://placehold.co/100x100/eee/ccc?text=ELO'}" alt="${p.nome_produto}"></td>
                        <td>${p.codigo_produto}</td>
                        <td>${p.nome_produto}</td>
                        <td>${formatCurrency(p.preco_minimo)}</td>
                        <td>${p.multiplos_de}</td>
                        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                        <td>
                            <button class="btn-action" style="background:#555; color:white;" onclick="openEditProductModal(${p.id})">Editar</button>
                            <button class="btn-action btn-danger" onclick="deleteProduct(${p.id})">Excluir</button>
                        </td>
                    `;
                });
            } catch (error) {
                console.error('Erro ao carregar produtos:', error);
                productsTableBody.innerHTML = '<tr><td colspan="7" style="color:var(--status-rejected); text-align: center;">Erro ao carregar lista.</td></tr>';
            }
        }

        function openAddProductModal() {
            isEditingProduct = false;
            productModal.style.display = 'flex';
            productModalTitle.textContent = 'Adicionar Novo Produto';
            saveProductBtn.textContent = 'Salvar Produto';
            productForm.reset(); 
            document.getElementById('product-ativo').checked = true;
            document.getElementById('product-estoque').checked = true;
            document.getElementById('product-multiplos').value = 1;
            productIdInput.value = '';
            productErrorMsg.style.display = 'none';
            productSuccessMsg.style.display = 'none';
        }
        
        async function openEditProductModal(id) {
            isEditingProduct = true;
            productForm.reset();
            productErrorMsg.style.display = 'none';
            productSuccessMsg.style.display = 'none';
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/admin/produtos/${id}`, { headers: getAuthHeaders() });
                if (!response.ok) throw new Error('Falha ao buscar produto');
                const p = await response.json();

                productModalTitle.textContent = 'Editar Produto';
                saveProductBtn.textContent = 'Atualizar Produto';
                
                productIdInput.value = p.id;
                document.getElementById('product-codigo').value = p.codigo_produto;
                document.getElementById('product-name').value = p.nome_produto;
                // Preço Mínimo é float
                document.getElementById('product-preco').value = p.preco_minimo; 
                document.getElementById('product-multiplos').value = p.multiplos_de;
                document.getElementById('product-url').value = p.imagem_url;
                document.getElementById('product-description').value = p.descricao;
                document.getElementById('product-estoque').checked = p.estoque_disponivel;
                document.getElementById('product-ativo').checked = p.esta_ativo;
                
                productModal.style.display = 'flex';

            } catch (error) {
                // CORREÇÃO: Substitui alert() por showCustomAlert()
                showCustomAlert('Erro ao carregar dados do produto para edição.');
                console.error(error);
            }
        }
        
        productForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            productErrorMsg.style.display = 'none';
            productSuccessMsg.style.display = 'none';
            saveProductBtn.disabled = true;

            const productData = {
                codigo_produto: document.getElementById('product-codigo').value,
                nome_produto: document.getElementById('product-name').value,
                preco_minimo: parseFloat(document.getElementById('product-preco').value),
                multiplos_de: parseInt(document.getElementById('product-multiplos').value),
                imagem_url: document.getElementById('product-url').value,
                descricao: document.getElementById('product-description').value,
                estoque_disponivel: document.getElementById('product-estoque').checked,
                esta_ativo: document.getElementById('product-ativo').checked,
            };

            const method = isEditingProduct ? 'PUT' : 'POST';
            const url = isEditingProduct ? `${API_BASE_URL}/api/admin/produtos/${productIdInput.value}` : `${API_BASE_URL}/api/admin/produtos`;
            
            try {
                const response = await fetch(url, {
                    method: method,
                    headers: getAuthHeaders(),
                    body: JSON.stringify(productData)
                });
                
                const data = await response.json();

                if (response.ok) {
                    productSuccessMsg.textContent = data.mensagem;
                    productSuccessMsg.style.display = 'block';
                    loadProductsTable(); 
                    loadDashboardStats();
                    setTimeout(() => productModal.style.display = 'none', 1500);
                } else {
                    productErrorMsg.textContent = data.erro || 'Falha ao salvar.';
                    productErrorMsg.style.display = 'block';
                }
            } catch (error) {
                console.error('Erro na operação de produto:', error);
                productErrorMsg.textContent = 'Erro de conexão com a API.';
                productErrorMsg.style.display = 'block';
            } finally {
                saveProductBtn.disabled = false;
            }
        });

        // CORREÇÃO: Refatorado para usar showCustomConfirm()
        function deleteProduct(id) {
            showCustomConfirm(`Tem certeza que deseja EXCLUIR o produto ID ${id}? Esta ação não pode ser desfeita.`, async (confirmed) => {
                if (!confirmed) return;

                try {
                    const response = await fetch(`${API_BASE_URL}/api/admin/produtos/${id}`, {
                        method: 'DELETE',
                        headers: getAuthHeaders()
                    });
                    const data = await response.json();
                    if (response.ok) {
                        showCustomAlert(data.mensagem); // Substitui alert()
                        loadProductsTable();
                        loadDashboardStats();
                    } else {
                        showCustomAlert(data.erro); // Substitui alert()
                    }
                } catch (error) {
                    showCustomAlert('Erro ao conectar com a API.'); // Substitui alert()
                }
            });
        }

        // --- Listeners Modal Produto ---
        document.getElementById('open-add-product-modal').addEventListener('click', openAddProductModal);
        document.getElementById('close-product-modal').addEventListener('click', () => productModal.style.display = 'none');
        document.getElementById('cancel-product').addEventListener('click', () => productModal.style.display = 'none');

        // =============================================================
        // --- FUNÇÕES DE GERENCIAMENTO DE CLIENTES ---
        // =============================================================
        
        async function loadClientsTable() {
            clientsTableBody.innerHTML = '<tr id="clients-loading"><td colspan="5" style="text-align: center;">Carregando...</td></tr>';
            try {
                const response = await fetch(`${API_BASE_URL}/api/admin/clientes`, { headers: getAuthHeaders() });
                if (!response.ok) {
                    if (response.status === 403) { showLogin(); return; }
                    throw new Error('Falha ao carregar clientes');
                }
                
                const clients = await response.json();
                clientsTableBody.innerHTML = '';

                if (clients.length === 0) {
                     clientsTableBody.innerHTML = '<tr><td colspan="5" style="text-align: center;">Nenhum cliente cadastrado.</td></tr>';
                     return;
                }
                
                clients.forEach(c => {
                    const statusClass = c.status_acesso === 'Ativo' ? 'status-true' : 'status-false';
                    const row = clientsTableBody.insertRow();
                    row.innerHTML = `
                        <td>${c.nome_cliente}</td>
                        <td>${c.cnpj || '-'}</td>
                        <td>${c.codigo_acesso}</td>
                        <td><span class="status-badge ${statusClass}">${c.status_acesso}</span></td>
                        <td>
                            <button class="btn-action btn-danger" onclick="deleteClient(${c.id})">Excluir</button>
                        </td>
                    `;
                });
            } catch (error) {
                console.error('Erro ao carregar clientes:', error);
                clientsTableBody.innerHTML = '<tr><td colspan="5" style="color:var(--status-rejected); text-align: center;">Erro ao carregar lista.</td></tr>';
            }
        }
        
        clientForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            clientErrorMsg.style.display = 'none';
            clientSuccessMsg.style.display = 'none';
            document.getElementById('save-client-btn').disabled = true;

            const clientData = {
                nome_cliente: document.getElementById('client-name').value,
                cnpj: document.getElementById('client-cnpj').value,
                email_contato: document.getElementById('client-email').value,
                codigo_acesso: document.getElementById('client-codigo').value,
            };
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/admin/clientes`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify(clientData)
                });
                
                const data = await response.json();

                if (response.ok) {
                    clientSuccessMsg.textContent = data.mensagem;
                    clientSuccessMsg.style.display = 'block';
                    loadClientsTable();
                    loadDashboardStats();
                    setTimeout(() => clientModal.style.display = 'none', 1500);
                } else {
                    clientErrorMsg.textContent = data.erro || 'Falha ao salvar.';
                    clientErrorMsg.style.display = 'block';
                }
            } catch (error) {
                clientErrorMsg.textContent = 'Erro de conexão com a API.';
                clientErrorMsg.style.display = 'block';
            } finally {
                document.getElementById('save-client-btn').disabled = false;
            }
        });

        // CORREÇÃO: Refatorado para usar showCustomConfirm()
        function deleteClient(id) {
            showCustomConfirm(`Tem certeza que deseja EXCLUIR o cliente ID ${id}?`, async (confirmed) => {
                if (!confirmed) return;

                try {
                    const response = await fetch(`${API_BASE_URL}/api/admin/clientes/${id}`, {
                        method: 'DELETE',
                        headers: getAuthHeaders()
                    });
                    const data = await response.json();
                    if (response.ok) {
                        showCustomAlert(data.mensagem); // Substitui alert()
                        loadClientsTable();
                        loadDashboardStats();
                    } else {
                        showCustomAlert(data.erro); // Substitui alert()
                    }
                } catch (error) {
                    showCustomAlert('Erro ao conectar com a API.'); // Substitui alert()
                }
            });
        }

        // --- Listeners Modal Cliente ---
        document.getElementById('open-add-client-modal').addEventListener('click', () => {
            clientForm.reset();
            clientErrorMsg.style.display = 'none';
            clientSuccessMsg.style.display = 'none';
            clientModal.style.display = 'flex';
        });
        document.getElementById('close-client-modal').addEventListener('click', () => clientModal.style.display = 'none');
        document.getElementById('cancel-client').addEventListener('click', () => clientModal.style.display = 'none');

        // --- INICIALIZAÇÃO ---
        if (localStorage.getItem('admin_token')) {
            showPanel();
        } else {
            showLogin();
        }
    </script>
</body>
</html>